<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      /* ãƒ™ãƒ¼ã‚¹è¨­å®š */
      :root{
        --fz-base:20px;         /* æœ¬æ–‡ã‚µã‚¤ã‚ºï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰ */
        --fz-label:18px;        /* ãƒ©ãƒ™ãƒ«æ–‡å­— */
        --control-h:54px;       /* å…¥åŠ›UIã®é«˜ã• */
        --radius:12px;          /* è§’ä¸¸ */
        --gap:20px;             /* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é–“éš” */
      }
      @media (min-width:800px){
        :root{ --fz-base:18px; --fz-label:16px; --control-h:50px; }
      }

      html,body{
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
        font-size: var(--fz-base);
        line-height: 1.7;
        margin: 0;
        padding: 20px 22px;
        color: #111;
        -webkit-text-size-adjust: 100%;
      }

      h2{
        font-size: calc(var(--fz-base) + 6px);
        font-weight: 700;
        margin: 0 0 10px;
      }

      .muted{
        color:#666;
        font-size: calc(var(--fz-base) * 0.9);
      }

      .field{
        margin-bottom: var(--gap);
        max-width: 720px;
      }

      label{
        display:block;
        font-weight: 600;
        font-size: var(--fz-label);
        margin-bottom: 6px;
      }

      select, input[type="file"], button{
        width: 100%;
        font-size: var(--fz-base);
        height: var(--control-h);
        padding: 12px 14px;
        border: 1px solid #cfd4d9;
        border-radius: var(--radius);
        box-sizing: border-box;
        background: #fff;
        -webkit-appearance: none;
        appearance: none;
      }

      select{
        background-image:
          linear-gradient(45deg, transparent 50%, #666 50%),
          linear-gradient(135deg, #666 50%, transparent 50%);
        background-position: right 16px top 50%, right 10px top 50%;
        background-size: 6px 6px, 6px 6px;
        background-repeat: no-repeat;
        padding-right: 38px;
      }

      input[type="file"]{
        padding: 12px 14px;
      }

      button{
        background: #1a73e8;
        color: #fff;
        border: none;
        font-weight: 700;
        letter-spacing: .02em;
        box-shadow: 0 1px 2px rgba(0,0,0,.06);
      }
      button:disabled{ opacity: .6; }

      .status{ margin-top: 18px; max-width: 720px; font-size: var(--fz-base); }
      .item{
        padding: 12px 14px;
        border: 1px solid #e6e9ec;
        border-radius: 10px;
        margin-bottom: 10px;
        background: #fff;
      }
      .ok{ font-weight: 700; }
      .err{ color:#b00020; font-weight:700; }

      .spinner{
        display:inline-block;width:18px;height:18px;border:2px solid #cfd4d9;
        border-top-color:#333;border-radius:50%;animation:spin .8s linear infinite;vertical-align:-3px;
      }
      @keyframes spin{ to{ transform: rotate(360deg); } }

      a{ touch-action: manipulation; }
    </style>
    <style>
        * { 
          margin: 0; padding: 0; 
          box-sizing: border-box;
        }
        html {
          height: 100%;
          width: 100%;
        }
        body{
          position: absolute;
          transform-origin: top left;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/exifr/dist/full.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>
  </head>
  <body>
    <script>
        window.onload = function(){
          var scale = 1 / 0.4;
          document.body.style.width = 100/scale+"%";
          document.body.style.height = 100/scale+"%";
          document.body.style.transform = "scale("+scale+")";
        };
        window.resize = function(){
          var scale = 1 / 0.4;
          document.body.style.width = 100/scale+"%";
          document.body.style.height = 100/scale+"%";
          document.body.style.transform = "scale("+scale+")";
        };
    </script>
    <h2>æ²ç¤ºæ¿å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
    <p class="muted">éƒ½é“åºœçœŒã¨å¸‚åŒºç”ºæ‘ã‚’é¸ã³ã€å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚åŒæ™‚ã«è¤‡æ•°æŒ‡å®šã§ãã¾ã™ã€‚</p>
<!--    
    <p class="muted">å†™çœŸã«è¨˜éŒ²ã•ã‚Œã‚‹ä½ç½®æƒ…å ±ã®ç¢ºèªæ–¹æ³•<br>
    iOS: å†™çœŸã‚¢ãƒ—ãƒªã§å†™çœŸã‚’é–‹ãã€ã€Œiã€ãƒãƒ¼ã‚¯ã‚’æŠ¼ã—ã¾ã™ã€‚åœ°å›³ã‚„ä½æ‰€ãŒå‡ºã‚Œã°ä½ç½®æƒ…å ±ãŒã¤ã„ã¦ã„ã¾ã™ã€‚<br>
    Android: Googleãƒ•ã‚©ãƒˆã§å†™çœŸã‚’é–‹ãã€ã€Œiã€ãƒãƒ¼ã‚¯ï¼ˆæƒ…å ±ï¼‰ã‚’æŠ¼ã—ã¾ã™ã€‚åœ°å›³ã‚„å ´æ‰€ãŒå‡ºã‚Œã°ä½ç½®æƒ…å ±ãŒã¤ã„ã¦ã„ã¾ã™ã€‚<br>
    â€»ã‚¹ãƒãƒ›ã®ã€Œä½ç½®æƒ…å ±ã‚’å«ã‚ãªã„ã€è¨­å®šã«ãªã£ã¦ã„ã‚‹ã¨ä½ç½®æƒ…å ±ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚</p>
-->
    <div class="field">
      <label for="prefecture">éƒ½é“åºœçœŒ</label>
      <select id="prefecture" onchange="loadCities()">
        <option>èª­ã¿è¾¼ã¿ä¸­...</option>
      </select>
    </div>

    <div class="field">
      <label for="city">å¸‚åŒºç”ºæ‘</label>
      <select id="city">
        <option value="">éƒ½é“åºœçœŒã‚’å…ˆã«é¸ã‚“ã§ãã ã•ã„</option>
      </select>
    </div>

    <div class="field" id="wardField" style="display:none;">
      <label for="ward">è¡Œæ”¿åŒº</label>
      <select id="ward">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      </select>
    </div>

    <div class="field">
      <label for="boardNo">æ²ç¤ºæ¿ç•ªå·ï¼ˆä¾‹: 4-12ï¼‰</label>
      <input id="boardNo" type="text" inputmode="text" placeholder="ä¾‹: 4-12">
    </div>

    <div class="field">
      <label for="comment">ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆè„šç«‹ãŒå¿…è¦ ç­‰ï¼‰</label>
      <textarea id="comment" rows="2" style="width:100%; padding:12px 14px; border:1px solid #cfd4d9; border-radius:12px; box-sizing:border-box;"></textarea>
    </div>

    <p class="muted">â€»æ²ç¤ºæ¿ç•ªå·ã€ã‚³ãƒ¡ãƒ³ãƒˆã¯ä»»æ„ã§ã™ã€‚è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ãŸå ´åˆã‚‚åŒã˜å†…å®¹ãŒè¨˜éŒ²ã•ã‚Œã¾ã™ã€‚</p>

    <div class="field">
      <label for="files">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</label>
      <input type="file" id="files" multiple accept="image/*,video/*,.heic,.jpg,.jpeg,.png">
    </div>

    <div class="field">
      <button id="btnUpload" onclick="uploadFiles()">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
    </div>

    <div id="summary" class="muted"></div>
    <div id="status" class="status"></div>

    <script>
      let locationData = {};
      let wardMap = {};           // ã“ã“ã«å…¨Wardã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      let wardReady = false;

      const $ = (id) => document.getElementById(id);

      function loadPrefectures() {
        // éƒ½é“åºœçœŒãƒ»å¸‚ã®å–å¾—
        google.script.run.withSuccessHandler((result) => {
          locationData = result || {};
          const prefSel = $('prefecture');
          prefSel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
          Object.keys(locationData).forEach(pref => {
            const opt = document.createElement('option');
            opt.value = pref; opt.textContent = pref;
            prefSel.appendChild(opt);
          });
          $('summary').textContent = '';
        }).withFailureHandler((e)=>{
          $('summary').textContent = 'é¸æŠè‚¢ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e && e.message ? e.message : e);
        }).getLocationOptions();

        // â˜… Wardãƒãƒƒãƒ—ã‚’å…ˆã«å…¨éƒ¨ãƒ­ãƒ¼ãƒ‰ï¼ˆä»¥å¾Œã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã ã‘ã§åˆ‡æ›¿ï¼‰
        google.script.run
          .withSuccessHandler((map) => { wardMap = map || {}; wardReady = true; })
          .getWardMap();
      }

      function loadCities() {
        const pref = $('prefecture').value;
        const cities = locationData[pref] || [];
        const citySel = $('city');
        citySel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        cities.forEach(city => {
          const opt = document.createElement('option');
          opt.value = city; opt.textContent = city;
          citySel.appendChild(opt);
        });
        citySel.onchange = showWardsInstant;
        // ãƒªã‚»ãƒƒãƒˆ
        $('ward').innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        $('wardField').style.display = 'none';
      }

      // â˜… ã‚µãƒ¼ãƒå‘¼ã³å‡ºã—ã¯ä¸è¦ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å³æ™‚è¡¨ç¤º
      function showWardsInstant() {
        const pref = $('prefecture').value;
        const city = $('city').value;
        const wardSel = $('ward');

        // ã¾ã Wardãƒãƒƒãƒ—ãŒæœªãƒ­ãƒ¼ãƒ‰ãªã‚‰ã€Œèª­ã¿è¾¼ã¿ä¸­ã€ã‚’è¦‹ã›ã¦ãŠã
        if (!wardReady) {
          wardSel.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­â€¦</option>';
          $('wardField').style.display = '';
          return;
        }

        const wards = (wardMap[pref] && wardMap[pref][city]) ? wardMap[pref][city] : [];
        if (wards.length) {
          wardSel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
          wards.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w; opt.textContent = w;
            wardSel.appendChild(opt);
          });
          $('wardField').style.display = '';
        } else {
          $('wardField').style.display = 'none';
          wardSel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        }
      }

      // HEICåˆ¤å®š
      function isHeic(file) {
        const name = (file.name || '').toLowerCase();
        return file.type === 'image/heic' || name.endsWith('.heic');
      }

      // File/Blob -> base64ï¼ˆdataURLï¼‰
      function blobToDataURL(blob) {
        return new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = e => resolve(String(e.target.result));
          r.onerror = reject;
          r.readAsDataURL(blob);
        });
      }

      // EXIFã‹ã‚‰ç·¯åº¦çµŒåº¦ãƒ»æ’®å½±æ™‚åˆ»ã‚’æŠ½å‡ºï¼ˆexifrï¼‰
      async function extractExif(fileOrBlob) {
        try {
          const d = await exifr.parse(fileOrBlob, { gps: true, tiff: true, ifd0: true, exif: true });
          if (!d) return {};
          const lat = d.latitude != null ? d.latitude : undefined;
          const lng = d.longitude != null ? d.longitude : undefined;
          // DateTimeOriginal or CreateDate ã®æ–‡å­—åˆ—åŒ–
          const dt = d.DateTimeOriginal || d.CreateDate || d.ModifyDate || null;
          const takenAt = dt ? new Date(dt).toISOString() : undefined;
          return { lat, lng, takenAt };
        } catch(e) {
          return {};
        }
      }

      function setBusy(busy) {
        $('btnUpload').disabled = busy;
        $('btnUpload').textContent = busy ? 'é€ä¿¡ä¸­â€¦' : 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';
      }

      function addStatusLine(html) {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = html;
        document.getElementById('status').prepend(div);
        return div;              // â† è¿½åŠ ï¼šå‘¼ã³å‡ºã—å…ƒã§ä¸­èº«ã‚’æ›´æ–°ã™ã‚‹ãŸã‚
      }

      async function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = e => resolve(String(e.target.result));
          reader.onerror = e => reject(e);
          reader.readAsDataURL(file); // data:...;base64,XXXX
        });
      }

      function shortName(name, max=60) {
        return name.length > max ? name.slice(0, max-10) + 'â€¦' + name.slice(-9) : name;
      }

      function uploadFiles() {
        const pref = $('prefecture').value;
        const city = $('city').value;
        const ward = $('ward').value || '';
        const boardNo = $('boardNo').value.trim();
        const comment = $('comment').value.trim();
        const files = Array.from($('files').files || []);
        if (!pref || !city || files.length === 0) {
          alert('éƒ½é“åºœçœŒãƒ»å¸‚åŒºç”ºæ‘ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        setBusy(true);
        $('summary').innerHTML = `<span class="spinner"></span> ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æº–å‚™ä¸­â€¦`;
        $('status').innerHTML = '';

        google.script.run
          .withSuccessHandler(async (folderId) => {
            if (!folderId) {
              setBusy(false);
              $('summary').textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚Fåˆ—URLã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
              return;
            }
            const folderUrl = `https://drive.google.com/drive/folders/${folderId}`;

            let ok = 0, ng = 0;
            $('summary').innerHTML = `<span class="spinner"></span> é€ä¿¡ä¸­â€¦ 0 / ${files.length}`;

            for (let i = 0; i < files.length; i++) {
              let f = files[i];

              // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡Œï¼ˆã¾ãšãƒ•ã‚¡ã‚¤ãƒ«åã ã‘è¡¨ç¤ºï¼‰
              const row = addStatusLine(
                `è§£æä¸­ <span class="muted">${shortName(f.name)}</span> <span class="spinner"></span>`
              );

              try {
                let exif = await extractExif(f);
                let locTag = (exif.lat != null && exif.lng != null) ? 'ğŸ“' : '';

                if (isHeic(f)) {
                  // HEIC â†’ JPEG
                  const jpegBlob = await heic2any({ blob: f, toType: 'image/jpeg' });
                  const uploadName = f.name.replace(/\.heic$/i, '.jpeg').replace(/\.heif$/i, '.jpeg');
                  const dataUrl = await blobToDataURL(jpegBlob);
                  const base64 = dataUrl.split(',')[1];
                  const fileObj = { name: uploadName, mimeType: 'image/jpeg', data: base64 };

                  const res = await new Promise((resolve, reject) => {
                    google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)
                      .uploadSingleFileBase64(pref, city, ward, fileObj, folderId, exif, boardNo, comment);
                  });

                  ok++;
                  row.innerHTML = `âœ… å®Œäº† <span class="ok">${res.name}</span> ${locTag} â€” <a href="${res.url}" target="_blank">Driveã§é–‹ã</a>`;
                } else {
                  // JPEG/PNGãªã©
                  const dataUrl = await fileToBase64(f);
                  const base64 = dataUrl.split(',')[1];
                  const fileObj = { name: f.name, mimeType: f.type || 'application/octet-stream', data: base64 };

                  const res = await new Promise((resolve, reject) => {
                    google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)
                      .uploadSingleFileBase64(pref, city, ward, fileObj, folderId, exif, boardNo, comment);
                  });

                  ok++;
                  row.innerHTML = `âœ… å®Œäº† <span class="ok">${res.name}</span> ${locTag} â€” <a href="${res.url}" target="_blank">Driveã§é–‹ã</a>`;
                }
              } catch (e) {
                ng++;
                row.innerHTML = `âŒ å¤±æ•— <span class="err">${shortName(f.name)}</span> â€” ${e && e.message ? e.message : e}`;
              }
              $('summary').textContent = `é€ä¿¡ä¸­â€¦ ${ok + ng} / ${files.length}ï¼ˆæˆåŠŸ: ${ok}ãƒ»å¤±æ•—: ${ng}ï¼‰`;
            }

            setBusy(false);
            // å…¨ä»¶å®Œäº†ï¼‹ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ããƒªãƒ³ã‚¯
            $('summary').innerHTML = `å®Œäº†ï¼ æˆåŠŸ: ${ok}ãƒ»å¤±æ•—: ${ng} â€” <a href="${folderUrl}" target="_blank">ãƒ•ã‚©ãƒ«ãƒ€ã‚’Driveã§é–‹ã</a>`;

          })
          .withFailureHandler((e) => {
            setBusy(false);
            $('summary').textContent = 'ãƒ•ã‚©ãƒ«ãƒ€å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e && e.message ? e.message : e);
          })
          .getUploadFolderId(pref, city);
      }

      // åˆæœŸåŒ–
      loadPrefectures();
    </script>
  </body>
</html>
